{% extends 'includes/base_generic.html' %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}
<div class="container mx-auto p-6">
    <h1 class="text-4xl font-extrabold text-gray-900 mb-6">Admin Dashboard</h1>

    <div id="loading" class="hidden">Loading...</div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
        <!-- Manage Scenarios -->
        <div class="bg-white shadow-lg rounded-lg p-6 col-span-3">
            <h3 class="text-2xl font-bold text-indigo-900 mb-4">Manage Scenarios</h3>
            <ul class="divide-y divide-gray-200">
                {% for scenario in scenarios %}
                <li class="py-4 flex justify-between items-center">
                    <div>
                        <p class="text-lg font-medium text-gray-900">
                            {{ scenario.name }} - {{ scenario.description }}
                        </p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="confirmAction('start', {{ scenario.id }})"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            Start
                        </button>
                        <button onclick="confirmAction('pause', {{ scenario.id }})"
                            class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded">
                            Pause
                        </button>
                        <button onclick="confirmAction('stop', {{ scenario.id }})"
                            class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                            Stop
                        </button>
                        <button onclick="confirmAction('publish', {{ scenario.id }})"
                            class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                            Publish
                        </button>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>

        <!-- Create Scenario -->
        <div class="bg-white shadow-lg rounded-lg p-6 col-span-3">
            <h3 class="text-2xl font-bold text-indigo-900 mb-4">Create Scenario</h3>
            <form id="scenarioForm" onsubmit="event.preventDefault(); submitScenario();">
                <!-- Scenario Details -->
                <div class="mb-4">
                    <label for="scenarioName" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="scenarioName" name="scenarioName"
                        class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required />
                </div>
                <div class="mb-4">
                    <label for="scenarioDescription" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="scenarioDescription" name="scenarioDescription"
                        class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
                </div>

                <!-- Collapsible Simulation Settings -->
                <div class="mb-4">
                    <h4 class="text-xl font-semibold text-gray-900 mb-2 cursor-pointer"
                        onclick="toggleSection('simulationSettings')">
                        Simulation Settings
                    </h4>
                    <div id="simulationSettings" class="hidden">
                        <label for="maxUsers" class="block text-sm font-medium text-gray-700">Max Users</label>
                        <input type="number" id="maxUsers" name="maxUsers"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" required />
                        <label for="maxCompanies" class="block text-sm font-medium text-gray-700">Max Companies</label>
                        <input type="number" id="maxCompanies" name="maxCompanies"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" required />
                        <label for="timerStep" class="block text-sm font-medium text-gray-700">Timer Step</label>
                        <input type="number" id="timerStep" name="timerStep"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" required />
                        <label for="timerStepUnit" class="block text-sm font-medium text-gray-700">Timer Step Unit</label>
                        <select id="timerStepUnit" name="timerStepUnit"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" required>
                            <option value="second">Second</option>
                            <option value="minute">Minute</option>
                            <option value="hour">Hour</option>
                            <option value="day">Day</option>
                            <option value="month">Month</option>
                            <option value="year">Year</option>
                        </select>
                    </div>
                </div>

                <!-- Collapsible Company and Stock Details -->
                <div class="mb-4">
                    <h4 class="text-xl font-semibold text-gray-900 mb-2 cursor-pointer"
                        onclick="toggleSection('companyStockDetails')">
                        Company and Stock Details
                    </h4>
                    <div id="companyStockDetails" class="hidden">
                        <label for="companyName" class="block text-sm font-medium text-gray-700">Company Name</label>
                        <input type="text" id="companyName" name="companyName"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" required />
                        <label for="companyBackstory" class="block text-sm font-medium text-gray-700">Backstory</label>
                        <textarea id="companyBackstory" name="companyBackstory"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" required></textarea>
                        <label for="companySector" class="block text-sm font-medium text-gray-700">Sector</label>
                        <input type="text" id="companySector" name="companySector"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" required />
                        <label for="companyCountry" class="block text-sm font-medium text-gray-700">Country</label>
                        <input type="text" id="companyCountry" name="companyCountry"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" required />
                        <label for="companyIndustry" class="block text-sm font-medium text-gray-700">Industry</label>
                        <input type="text" id="companyIndustry" name="companyIndustry"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" required />

                        <label for="stockTicker" class="block text-sm font-medium text-gray-700">Ticker</label>
                        <input type="text" id="stockTicker" name="stockTicker"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" required />
                        <label for="stockPrice" class="block text-sm font-medium text-gray-700">Price</label>
                        <input type="number" step="0.01" id="stockPrice" name="stockPrice"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" required />
                        <label for="stockOpenPrice" class="block text-sm font-medium text-gray-700">Open Price</label>
                        <input type="number" step="0.01" id="stockOpenPrice" name="stockOpenPrice"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" required />
                        <label for="stockHighPrice" class="block text-sm font-medium text-gray-700">High Price</label>
                        <input type="number" step="0.01" id="stockHighPrice" name="stockHighPrice"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" required />
                        <label for="stockLowPrice" class="block text-sm font-medium text-gray-700">Low Price</label>
                        <input type="number" step="0.01" id="stockLowPrice" name="stockLowPrice"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" required />
                        <label for="stockClosePrice" class="block text-sm font-medium text-gray-700">Close Price</label>
                        <input type="number" step="0.01" id="stockClosePrice" name="stockClosePrice"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" required />
                        <label for="stockPartialShare" class="block text-sm font-medium text-gray-700">Partial Share</label>
                        <input type="number" step="0.01" id="stockPartialShare" name="stockPartialShare"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" required />
                        <label for="stockCompleteShare" class="block text-sm font-medium text-gray-700">Complete Share</label>
                        <input type="number" id="stockCompleteShare" name="stockCompleteShare"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" required />
                    </div>
                </div>

                <!-- Collapsible Events -->
                <div class="mb-4">
                    <h4 class="text-xl font-semibold text-gray-900 mb-2 cursor-pointer"
                        onclick="toggleSection('eventsSection')">
                        Events
                    </h4>
                    <div id="eventsSection" class="hidden">
                        <div id="eventsContainer"></div>
                        <button type="button" onclick="addEvent()"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            Add Event
                        </button>
                    </div>
                </div>

                <!-- Collapsible Triggers -->
                <div class="mb-4">
                    <h4 class="text-xl font-semibold text-gray-900 mb-2 cursor-pointer"
                        onclick="toggleSection('triggersSection')">
                        Triggers
                    </h4>
                    <div id="triggersSection" class="hidden">
                        <div id="triggersContainer"></div>
                        <button type="button" onclick="addTrigger()"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            Add Trigger
                        </button>
                    </div>
                </div>

                <!-- Collapsible News -->
                <div class="mb-4">
                    <h4 class="text-xl font-semibold text-gray-900 mb-2 cursor-pointer"
                        onclick="toggleSection('newsSection')">
                        News
                    </h4>
                    <div id="newsSection" class="hidden">
                        <div id="newsContainer"></div>
                        <button type="button" onclick="addNews()"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            Add News
                        </button>
                    </div>
                </div>

                <!-- Collapsible Teams -->
                <div class="mb-4">
                    <h4 class="text-xl font-semibold text-gray-900 mb-2 cursor-pointer"
                        onclick="toggleSection('teamsSection')">
                        Teams
                    </h4>
                    <div id="teamsSection" class="hidden">
                        <div id="teamsContainer"></div>
                        <button type="button" onclick="addTeam()"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            Add Team
                        </button>
                    </div>
                </div>

                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Create Scenario
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    function toggleSection(sectionId) {
        const section = document.getElementById(sectionId);
        section.classList.toggle('hidden');
    }

    function submitScenario() {
        const scenario = {
            name: document.getElementById('scenarioName').value,
            description: document.getElementById('scenarioDescription').value,
            simulation_settings: {
                max_users: document.getElementById('maxUsers').value,
                max_companies: document.getElementById('maxCompanies').value,
                timer_step: document.getElementById('timerStep').value,
                timer_step_unit: document.getElementById('timerStepUnit').value,
            },
            stock: [{
                company: {
                    name: document.getElementById('companyName').value,
                    backstory: document.getElementById('companyBackstory').value,
                    sector: document.getElementById('companySector').value,
                    country: document.getElementById('companyCountry').value,
                    industry: document.getElementById('companyIndustry').value,
                },
                ticker: document.getElementById('stockTicker').value,
                price: document.getElementById('stockPrice').value,
                open_price: document.getElementById('stockOpenPrice').value,
                high_price: document.getElementById('stockHighPrice').value,
                low_price: document.getElementById('stockLowPrice').value,
                close_price: document.getElementById('stockClosePrice').value,
                partial_share: document.getElementById('stockPartialShare').value,
                complete_share: document.getElementById('stockCompleteShare').value,
            }],
            events: [],
            triggers: [],
            news: [],
            teams: [],
        };

        const addEntries = (prefix, count, type) => {
            for (let i = 1; i <= count; i++) {
                if (document.getElementById(`${prefix}Name-${i}`)) {
                    scenario[type].push({
                        name: document.getElementById(`${prefix}Name-${i}`).value,
                        date: document.getElementById(`${prefix}Date-${i}`)?.value,
                        description: document.getElementById(`${prefix}Description-${i}`)?.value,
                        condition: document.getElementById(`${prefix}Condition-${i}`)?.value,
                        action: document.getElementById(`${prefix}Action-${i}`)?.value,
                        title: document.getElementById(`${prefix}Title-${i}`)?.value,
                        content: document.getElementById(`${prefix}Content-${i}`)?.value,
                    });
                }
            }
        };

        addEntries('event', eventCount, 'events');
        addEntries('trigger', triggerCount, 'triggers');
        addEntries('news', newsCount, 'news');
        addEntries('team', teamCount, 'teams');

        toggleLoading(true);
        fetch("{% url 'create_scenario' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify(scenario),
        }).then(response => {
            toggleLoading(false);
            if (response.ok) {
                alert("Scenario created successfully");
                location.reload(); // Reload the page to update the list of scenarios
            } else {
                response.json().then(data => alert(`Failed to create scenario: ${JSON.stringify(data.errors)}`));
            }
        }).catch(error => {
            toggleLoading(false);
            alert(`Failed to create scenario: ${error.message}`);
        });
    }

    function confirmAction(action, scenarioId) {
        if (confirm(`Are you sure you want to ${action} this scenario?`)) {
            toggleLoading(true);
            fetch(`/api/scenario/${action}/${scenarioId}/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
            }).then(response => {
                toggleLoading(false);
                if (response.ok) {
                    alert(`Scenario ${action}ed successfully`);
                } else {
                    alert(`Failed to ${action} scenario`);
                }
            }).catch(error => {
                toggleLoading(false);
                alert(`Failed to ${action} scenario: ${error.message}`);
            });
        }
    }

    let eventCount = 0;
    let triggerCount = 0;
    let newsCount = 0;
    let teamCount = 0;

    function addEntry(prefix, count, containerId, labels) {
        count++;
        let entryHTML = `<div id="${prefix}-${count}" class="mb-4">`;
        labels.forEach(label => {
            entryHTML += `
              <label for="${prefix}${label.replace(/\s+/g, '')}-${count}" class="block mb-2 text-sm font-medium text-gray-700">${label}</label>
              <input type="${label.includes('Date') ? 'datetime-local' : 'text'}" id="${prefix}${label.replace(/\s+/g, '')}-${count}" class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
          `;
        });
        entryHTML += `<button type="button" onclick="removeEntry('${prefix}', ${count})" class="text-red-500 hover:text-red-700 mt-2">Remove ${prefix.charAt(0).toUpperCase() + prefix.slice(1)}</button></div>`;
        document.getElementById(containerId).insertAdjacentHTML('beforeend', entryHTML);
        return count;
    }

    function addEvent() {
        eventCount = addEntry('event', eventCount, 'eventsContainer', ['Event Name', 'Event Date', 'Event Description']);
    }

    function addTrigger() {
        triggerCount = addEntry('trigger', triggerCount, 'triggersContainer', ['Trigger Name', 'Condition', 'Action']);
    }

    function addNews() {
        newsCount = addEntry('news', newsCount, 'newsContainer', ['News Title', 'Content', 'Link to Event']);
    }

    function addTeam() {
        teamCount = addEntry('team', teamCount, 'teamsContainer', ['Team Name']);
    }

    function removeEntry(prefix, id) {
        document.getElementById(`${prefix}-${id}`).remove();
    }
</script>
{% endblock %}
