{% extends 'includes/base_generic.html' %} {% block title %}Admin Dashboard
{% endblock %} {% block content %}
<div class="container mx-auto p-6">
    <h1 class="text-4xl font-extrabold text-gray-900 mb-6">Admin Dashboard</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
        <!-- Manage Scenarios -->
        <div class="bg-white shadow-lg rounded-lg p-6 col-span-3">
            <h3 class="text-2xl font-bold text-indigo-900 mb-4">Manage Scenarios</h3>
            <ul class="divide-y divide-gray-200">
                {% for scenario in scenarios %}
                <li class="py-4 flex justify-between items-center">
                    <div>
                        <p class="text-lg font-medium text-gray-900">
                            {{ scenario.name }} - {{ scenario.description }}
                        </p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="startScenario({{ scenario.id }})"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            Start
                        </button>
                        <button onclick="pauseScenario({{ scenario.id }})"
                            class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded">
                            Pause
                        </button>
                        <button onclick="stopScenario({{ scenario.id }})"
                            class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                            Stop
                        </button>
                        <button onclick="publishScenario({{ scenario.id }})"
                            class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                            Publish
                        </button>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>

        <!-- Create Scenario -->
        <div class="bg-white shadow-lg rounded-lg p-6 col-span-3">
            <h3 class="text-2xl font-bold text-indigo-900 mb-4">Create Scenario</h3>
            <form id="scenarioForm">
                <!-- Scenario Details -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="scenarioName"
                        class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" />
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="scenarioDescription"
                        class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <!-- Collapsible Simulation Settings -->
                <div class="mb-4">
                    <h4 class="text-xl font-semibold text-gray-900 mb-2 cursor-pointer"
                        onclick="toggleSection('simulationSettings')">
                        Simulation Settings
                    </h4>
                    <div id="simulationSettings" class="hidden">
                        <label class="block text-sm font-medium text-gray-700">Max Users</label>
                        <input type="number" id="maxUsers"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" />
                        <label class="block text-sm font-medium text-gray-700">Max Companies</label>
                        <input type="number" id="maxCompanies"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" />
                        <label class="block text-sm font-medium text-gray-700">Timer Step</label>
                        <input type="number" id="timerStep"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" />
                        <label class="block text-sm font-medium text-gray-700">Timer Step Unit</label>
                        <select id="timerStepUnit"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4">
                            <option value="second">Second</option>
                            <option value="minute">Minute</option>
                            <option value="hour">Hour</option>
                            <option value="day">Day</option>
                            <option value="month">Month</option>
                            <option value="year">Year</option>
                        </select>
                    </div>
                </div>

                <!-- Collapsible Company and Stock Details -->
                <div class="mb-4">
                    <h4 class="text-xl font-semibold text-gray-900 mb-2 cursor-pointer"
                        onclick="toggleSection('companyStockDetails')">
                        Company and Stock Details
                    </h4>
                    <div id="companyStockDetails" class="hidden">
                        <label class="block text-sm font-medium text-gray-700">Company Name</label>
                        <input type="text" id="companyName"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" />
                        <label class="block text-sm font-medium text-gray-700">Backstory</label>
                        <textarea id="companyBackstory"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4"></textarea>
                        <label class="block text-sm font-medium text-gray-700">Sector</label>
                        <input type="text" id="companySector"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" />
                        <label class="block text-sm font-medium text-gray-700">Country</label>
                        <input type="text" id="companyCountry"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" />
                        <label class="block text-sm font-medium text-gray-700">Industry</label>
                        <input type="text" id="companyIndustry"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" />

                        <label class="block text-sm font-medium text-gray-700">Ticker</label>
                        <input type="text" id="stockTicker"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" />
                        <label class="block text-sm font-medium text-gray-700">Price</label>
                        <input type="number" step="0.01" id="stockPrice"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" />
                        <label class="block text-sm font-medium text-gray-700">Open Price</label>
                        <input type="number" step="0.01" id="stockOpenPrice"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" />
                        <label class="block text-sm font-medium text-gray-700">High Price</label>
                        <input type="number" step="0.01" id="stockHighPrice"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" />
                        <label class="block text-sm font-medium text-gray-700">Low Price</label>
                        <input type="number" step="0.01" id="stockLowPrice"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" />
                        <label class="block text-sm font-medium text-gray-700">Close Price</label>
                        <input type="number" step="0.01" id="stockClosePrice"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" />
                        <label class="block text-sm font-medium text-gray-700">Partial Share</label>
                        <input type="number" step="0.01" id="stockPartialShare"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" />
                        <label class="block text-sm font-medium text-gray-700">Complete Share</label>
                        <input type="number" id="stockCompleteShare"
                            class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" />
                    </div>
                </div>

                <!-- Collapsible Events -->
                <div class="mb-4">
                    <h4 class="text-xl font-semibold text-gray-900 mb-2 cursor-pointer"
                        onclick="toggleSection('eventsSection')">
                        Events
                    </h4>
                    <div id="eventsSection" class="hidden">
                        <div id="eventsContainer"></div>
                        <button type="button" onclick="addEvent()"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            Add Event
                        </button>
                    </div>
                </div>

                <!-- Collapsible Triggers -->
                <div class="mb-4">
                    <h4 class="text-xl font-semibold text-gray-900 mb-2 cursor-pointer"
                        onclick="toggleSection('triggersSection')">
                        Triggers
                    </h4>
                    <div id="triggersSection" class="hidden">
                        <div id="triggersContainer"></div>
                        <button type="button" onclick="addTrigger()"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            Add Trigger
                        </button>
                    </div>
                </div>

                <!-- Collapsible News -->
                <div class="mb-4">
                    <h4 class="text-xl font-semibold text-gray-900 mb-2 cursor-pointer"
                        onclick="toggleSection('newsSection')">
                        News
                    </h4>
                    <div id="newsSection" class="hidden">
                        <div id="newsContainer"></div>
                        <button type="button" onclick="addNews()"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            Add News
                        </button>
                    </div>
                </div>

                <!-- Collapsible Teams -->
                <div class="mb-4">
                    <h4 class="text-xl font-semibold text-gray-900 mb-2 cursor-pointer"
                        onclick="toggleSection('teamsSection')">
                        Teams
                    </h4>
                    <div id="teamsSection" class="hidden">
                        <div id="teamsContainer"></div>
                        <button type="button" onclick="addTeam()"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            Add Team
                        </button>
                    </div>
                </div>

                <button type="button" onclick="submitScenario()"
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Create Scenario
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    function toggleSection(sectionId) {
        const section = document.getElementById(sectionId);
        section.classList.toggle('hidden');
    }

    function submitScenario() {
        const scenario = {
            name: document.getElementById('scenarioName').value,
            description: document.getElementById('scenarioDescription').value,
            simulation_settings: {
                max_users: document.getElementById('maxUsers').value,
                max_companies: document.getElementById('maxCompanies').value,
                timer_step: document.getElementById('timerStep').value,
                timer_step_unit: document.getElementById('timerStepUnit').value,
            },
            stock: [{
                company: {
                    name: document.getElementById('companyName').value,
                    backstory: document.getElementById('companyBackstory').value,
                    sector: document.getElementById('companySector').value,
                    country: document.getElementById('companyCountry').value,
                    industry: document.getElementById('companyIndustry').value,
                }
            }
            ],
            events: [
                {
                    name: document.getElementById('eventName-1').value,
                    date: document.getElementById('eventDate-1').value,
                    description: document.getElementById('eventDescription-1').value,
                },
            ],
            triggers: [
                {
                    name: document.getElementById('triggerName-1').value,
                    description: document.getElementById('triggerDescription-1').value,
                    type: document.getElementById('triggerType-1').value,
                    value: document.getElementById('triggerValue-1').value,
                    events: document.getElementById('triggerEvents-1').value,
                    timestamp: document.getElementById('triggerTimestamp-1').value,
                },
            ],
            news: [
                {
                    title: document.getElementById('newsTitle-1').value,
                    content: document.getElementById('newsContent-1').value,
                    published_date: document.getElementById('newsPublished-1').value,
                    event: document.getElementById('newsEvent-1').value,
                    scenario: document.getElementById('newsScenario-1').value,
                },
            ],
            teams: [
                {
                    name: document.getElementById('teamName-1').value,
                    members: document.getElementById('teamMembers-1').value,
                },
            ],
        };

        const addEntries = (prefix, count, type) => {
            for (let i = 1; i <= count; i++) {
                if (document.getElementById(`${prefix}Name-${i}`)) {
                    scenario[type].push({
                        name: document.getElementById(`${prefix}Name-${i}`).value,
                        date: document.getElementById(`${prefix}Date-${i}`)?.value,
                        description: document.getElementById(`${prefix}Description-${i}`)?.value,
                        condition: document.getElementById(`${prefix}Condition-${i}`)?.value,
                        action: document.getElementById(`${prefix}Action-${i}`)?.value,
                        title: document.getElementById(`${prefix}Title-${i}`)?.value,
                        content: document.getElementById(`${prefix}Content-${i}`)?.value,
                    });
                }
            }
        };

        addEntries('event', eventCount, 'events');
        addEntries('trigger', triggerCount, 'triggers');
        addEntries('news', newsCount, 'news');
        addEntries('team', teamCount, 'teams');

        fetch("{% url 'create_scenario' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify(scenario),
        }).then(response => {
            if (response.ok) {
                alert("Scenario created successfully");
                location.reload(); // Reload the page to update the list of scenarios
            } else {
                response.json().then(data => alert(`Failed to create scenario: ${JSON.stringify(data.errors)}`));
            }
        });
    }

    function startScenario(scenarioId) {
        fetch(`/api/scenario/start/${scenarioId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
        }).then(response => {
            if (response.ok) {
                alert("Scenario started successfully");
            } else {
                alert("Failed to start scenario");
            }
        });
    }

    function pauseScenario(scenarioId) {
        fetch(`/api/scenario/pause/${scenarioId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
        }).then(response => {
            if (response.ok) {
                alert("Scenario paused successfully");
            } else {
                alert("Failed to pause scenario");
            }
        });
    }

    function stopScenario(scenarioId) {
        fetch(`/api/scenario/stop/${scenarioId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
        }).then(response => {
            if (response.ok) {
                alert("Scenario stopped successfully");
            } else {
                alert("Failed to stop scenario");
            }
        });
    }

    function publishScenario(scenarioId) {
        fetch(`/api/scenario/publish/${scenarioId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
        }).then(response => {
            if (response.ok) {
                alert("Scenario published successfully");
            } else {
                alert("Failed to publish scenario");
            }
        });
    }

    let eventCount = 0;
    let triggerCount = 0;
    let newsCount = 0;
    let teamCount = 0;

    function addEntry(prefix, count, containerId, labels) {
        count++;
        let entryHTML = `<div id="${prefix}-${count}" class="mb-4">`;
        labels.forEach(label => {
            entryHTML += `
              <label class="block mb-2 text-sm font-medium text-gray-700">${label}</label>
              <input type="${label.includes('Date') ? 'datetime-local' : 'text'}" id="${prefix}${label.replace(/\s+/g, '')}-${count}" class="block w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
          `;
        });
        entryHTML += `<button type="button" onclick="removeEntry('${prefix}', ${count})" class="text-red-500 hover:text-red-700 mt-2">Remove ${prefix.charAt(0).toUpperCase() + prefix.slice(1)}</button></div>`;
        document.getElementById(containerId).insertAdjacentHTML('beforeend', entryHTML);
        return count;
    }

    function addEvent() {
        eventCount = addEntry('event', eventCount, 'eventsContainer', ['Event Name', 'Event Date', 'Event Description']);
    }

    function addTrigger() {
        triggerCount = addEntry('trigger', triggerCount, 'triggersContainer', ['Trigger Name', 'Condition', 'Action']);
    }

    function addNews() {
        newsCount = addEntry('news', newsCount, 'newsContainer', ['News Title', 'Content', 'Link to Event']);
    }

    function addTeam() {
        teamCount = addEntry('team', teamCount, 'teamsContainer', ['Team Name']);
    }

    function removeEntry(prefix, id) {
        document.getElementById(`${prefix}-${id}`).remove();
    }
</script>
{% endblock %}