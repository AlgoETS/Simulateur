{% extends 'includes/base_no_nav.html' %}

{% block content %}
<div class="flex flex-1 overflow-hidden mb-16">
    <!-- Left Sidebar -->
    <div class="hidden md:flex md:flex-shrink-0 md:w-1/5 bg-white p-4 border-r border-gray-200">
        <div class="w-full">
            <h2 class="text-xl font-semibold mb-4">Transaction Orders</h2>
            <!-- Transaction Orders List -->
            <ul class="divide-y divide-gray-200">
                {% for transaction in transactions %}
                <li class="p-2 transaction">
                    <span class="ticker font-bold">{{ transaction.asset }}</span>
                    <span class="amount {% if transaction.amount > 0 %}text-green-500{% else %}text-red-500{% endif %}">{{ transaction.amount }}</span>
                    <span class="player text-gray-500">{{ transaction.portfolio.owner.user.username }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <!-- Main Content Area -->
    <div class="flex-1 flex flex-wrap p-4 overflow-auto">
        {% for company in companies %}
        <div class="w-full md:w-1/2 lg:w-1/3 p-2">
            <div class="bg-white p-4 rounded-lg shadow-lg h-full">
                <h3 class="text-lg font-semibold mb-4">{{ company.name }} ({{ company.ticker }})</h3>
                <canvas id="chart-{{ company.id }}" class="w-full h-64"></canvas>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<!-- Bottom News Ticker -->
<div class="w-full bg-gray-800 text-white p-4 fixed bottom-0">
    <div class="overflow-hidden relative">
        <div class="scrolling-news whitespace-nowrap animate-scroll">
            {% for news_item in news_items %}
            <span class="mx-4">{{ news_item.content }}</span>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Messages Container -->
<div id="messages" class="fixed bottom-16 right-4 space-y-2"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const companies = {{ companies|safe }};
    let charts = {};
    let data = {};

    companies.forEach(company => {
        const ctx = document.getElementById(`chart-${company.id}`).getContext('2d');
        data[company.name] = {
            labels: company.stock_prices.map(price => new Date(price.timestamp)),
            datasets: [{
                label: `${company.name} Stock Prices`,
                data: company.stock_prices.map(price => ({
                    x: new Date(price.timestamp),
                    o: price.open,
                    h: price.high,
                    l: price.low,
                    c: price.close
                })),
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                fill: false,
            }]
        };
        charts[company.name] = new Chart(ctx, {
            type: 'candlestick',
            data: data[company.name],
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day'
                        },
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Price'
                        }
                    }
                }
            }
        });
    });

    let socket = new WebSocket('ws://' + window.location.host + '/ws/simulation/stock/');

    socket.onopen = function () {
        console.log("WebSocket connection established");
        addMessage("WebSocket connection established", "green");
    };

    socket.onmessage = function (e) {
        console.log("Message received: " + e.data);
        const messageData = JSON.parse(e.data);
        if (messageData.name && messageData.timestamp) {
            updateChart(messageData);
        } else {
            console.warn("Received malformed message:", messageData);
        }
    };

    socket.onclose = function () {
        console.log("WebSocket connection closed");
        addMessage("WebSocket connection closed", "red");
    };

    socket.onerror = function (e) {
        console.log("WebSocket error: " + e.data);
        addMessage("WebSocket error: " + e.data, "red");
    };

    function updateChart(message) {
        const companyName = message.name;
        if (!data[companyName] || !data[companyName].datasets) {
            console.warn(`Chart data for ${companyName} is not initialized correctly.`);
            return;
        }
        const ohlcData = {
            x: new Date(message.timestamp),
            o: message.open,
            h: message.high,
            l: message.low,
            c: message.close
        };
        data[companyName].datasets[0].data.push(ohlcData);
        charts[companyName].update();
    }

    function addMessage(message, color) {
        const messageContainer = document.createElement('div');
        messageContainer.className = `bg-${color}-100 text-${color}-800 p-2 rounded shadow`;
        messageContainer.innerHTML = message;
        document.getElementById('messages').appendChild(messageContainer);
    }

    window.onbeforeunload = function () {
        if (socket) {
            socket.close();
        }
    };
});
</script>
{% endblock %}
