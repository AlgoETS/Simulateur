{% extends 'includes/base_no_nav.html' %}

{% block content %}
<div class="flex flex-1 overflow-hidden mb-16 bg-gray-100">
    <!-- Left Sidebar - Transaction Orders -->
    <div class="hidden md:flex md:flex-shrink-0 md:w-1/4 bg-white p-4 border-r border-gray-200">
        <div class="w-full">
            <h2 class="text-xl font-semibold mb-4">Transaction Orders</h2>
            <!-- Transaction Orders List -->
            <ul class="divide-y divide-gray-200">
                {% for transaction in transactions %}
                {% if transaction.orders.count == 0 %}
                <li class="p-2 text-gray-500">No orders</li>
                {% endif %}
                {% for order in transaction.orders.all %}
                <li class="p-2">
                    <span class="font-semibold">{{ order.user }}: {{ order.stock.name }} ({{ order.stock.ticker }})</span>
                    <span class="text-sm text-gray-500">{{ order.get_order_type_display }} - {{ order.quantity }} shares at ${{ order.price }}</span>
                </li>
                {% endfor %}
                {% endfor %}
            </ul>
        </div>
    </div>
    <!-- Main Content Area - Stock Charts -->
    <div class="flex-1 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 p-4 gap-4">
        {% for stock in stocks %}
        <div class="bg-white p-4 rounded-lg shadow-lg h-full flex flex-col">
            <h3 class="text-lg font-semibold mb-4">{{ stock.name }} ({{ stock.ticker }})</h3>
            <div id="chart-{{ stock.id }}" class="w-full h-64 flex-1"></div>
        </div>
        {% endfor %}
    </div>
</div>
<!-- Bottom News Ticker -->
<div class="w-full bg-gray-800 text-white p-4 fixed bottom-0">
    <div class="overflow-hidden relative">
        <div class="scrolling-news whitespace-nowrap animate-scroll">
            {% for news_item in news_items %}
            <span class="mx-4">{{ news_item.content }}</span>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Messages Container -->
<div id="messages" class="fixed bottom-16 right-4 space-y-2"></div>

<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.6/dist/lightweight-charts.standalone.production.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const stocks = {{ stocks|safe }};
    let charts = {};

    stocks.forEach(stock => {
        const chartElement = document.getElementById(`chart-${stock.id}`);
        const chart = LightweightCharts.createChart(chartElement, {
            width: chartElement.clientWidth,
            height: chartElement.clientHeight,
            layout: {
                backgroundColor: '#ffffff',
                textColor: '#000000',
            },
            grid: {
                vertLines: {
                    color: '#e0e0e0',
                },
                horzLines: {
                    color: '#e0e0e0',
                },
            },
            priceScale: {
                borderColor: '#cccccc',
            },
            timeScale: {
                borderColor: '#cccccc',
                timeVisible: true,
                secondsVisible: false,
            },
        });

        const candlestickSeries = chart.addCandlestickSeries();

        const data = stock.stock_prices.map(price => ({
            time: new Date(price.timestamp).getTime() / 1000,
            open: price.open_price,
            high: price.high_price,
            low: price.low_price,
            close: price.close_price,
        }));

        candlestickSeries.setData(data);

        charts[stock.name] = chart;
    });

    let socket = new WebSocket('ws://' + window.location.host + '/ws/simulation/stock/');

    socket.onopen = function () {
        console.log("WebSocket connection established");
        addMessage("WebSocket connection established", "green");
    };

    socket.onmessage = function (e) {
        console.log("Message received: " + e.data);
        const messageData = JSON.parse(e.data);
        if (messageData.name && messageData.timestamp) {
            updateChart(messageData);
        } else {
            console.warn("Received malformed message:", messageData);
        }
    };

    socket.onclose = function () {
        console.log("WebSocket connection closed");
        addMessage("WebSocket connection closed", "red");
    };

    socket.onerror = function (e) {
        console.log("WebSocket error: " + e.data);
        addMessage("WebSocket error: " + e.data, "red");
    };

    function updateChart(message) {
        const stockName = message.name;
        const chart = charts[stockName];
        if (!chart) {
            console.warn(`Chart for ${stockName} not found.`);
            return;
        }

        const ohlcData = {
            time: new Date(message.timestamp).getTime() / 1000,
            open: message.open_price,
            high: message.high_price,
            low: message.low_price,
            close: message.close_price
        };

        chart.series[0].update(ohlcData);
    }

    function addMessage(message, color) {
        const messageContainer = document.createElement('div');
        messageContainer.className = `bg-${color}-100 text-${color}-800 p-2 rounded shadow`;
        messageContainer.innerHTML = message;
        document.getElementById('messages').appendChild(messageContainer);
    }

    window.onbeforeunload = function () {
        if (socket) {
            socket.close();
        }
    };
});
</script>
{% endblock %}
