{% extends 'includes/base_generic.html' %}

{% block content %}
<div class="container mx-auto p-6">
    <h1 class="text-4xl font-extrabold text-gray-900 mb-6">{{ title }}</h1>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <!-- Stocks List -->
        <div class="col-span-1">
            <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-indigo-900 mb-4">Stocks List</h2>
                <form id="stockForm">
                    <div class="mb-4">
                        <label for="scenario" class="block text-sm font-medium text-gray-700 mb-2">Scenario</label>
                        <select id="scenario" name="scenario" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            {% for scenario in scenarios %}
                            <option value="{{ scenario.id }}" {% if scenario.id == current_scenario_id %}selected{% endif %}>{{ scenario.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="company" class="block text-sm font-medium text-gray-700 mb-2">Company</label>
                        <select id="company" name="company" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            {% for stock in stocks %}
                            <option value="{{ stock.id }}">{{ stock.company.name }} ({{ stock.ticker }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">Amount</label>
                        <input type="number" id="amount" name="amount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter amount" min="1" max="999">
                    </div>
                    <div class="mb-4">
                        <label for="price" class="block text-sm font-medium text-gray-700 mb-2">Price</label>
                        <input type="number" id="price" name="price" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter price" min="1" step="0.01">
                    </div>
                    <div class="flex space-x-4">
                        <button type="button" onclick="buyStock()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">Buy</button>
                        <button type="button" onclick="sellStock()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">Sell</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Order History -->
        <div class="col-span-1 md:col-span-2">
            <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-indigo-900 mb-4">Order History</h2>
                <ul class="divide-y divide-gray-200">
                    {% for order in orders %}
                    <li class="py-4">
                        <div class="flex justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-900">{{ order.transaction_type }} {{ order.quantity }} shares of {{ order.stock.ticker }}</p>
                                <p class="text-sm text-gray-500">{{ order.timestamp|date:"F j, Y, g:i a" }}</p>
                            </div>
                            <div class="text-sm text-gray-900">
                                ${{ order.price }}
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <!-- Portfolio Details -->
    <div class="bg-indigo-100 shadow rounded-lg p-6">
        <h2 class="text-2xl font-bold text-indigo-900 mb-4">Portfolio Details</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for stock_data in stocks_data %}
            <div class="bg-white p-4 rounded-lg shadow hover:shadow-md transition duration-200">
                <h3 class="text-lg font-semibold text-indigo-700">{{ stock_data.stock.ticker }}</h3>
                <p class="text-gray-600">Company: {{ stock_data.stock.company.name }}</p>
                <p class="text-gray-600">Current Price: <span class="text-green-600">${{ stock_data.stock.price }}</span></p>
                <p class="text-gray-600">Shares Owned: {{ stock_data.quantity }}</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function buyStock() {
        const stockId = document.getElementById('company').value;
        const amount = document.getElementById('amount').value;
        const price = document.getElementById('price').value;
        const scenarioId = document.getElementById('scenario').value;  // Ensure scenario ID is included
        const csrfToken = getCookie('csrftoken');

        fetch('/api/stock/buy/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({ stock_id: stockId, amount: amount, price: price, scenario_id: scenarioId }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Stock bought successfully');
                location.reload(); // Reload the page to update the portfolio and transactions
            } else {
                alert(data.message);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function sellStock() {
        const stockId = document.getElementById('company').value;
        const amount = document.getElementById('amount').value;
        const price = document.getElementById('price').value;
        const scenarioId = document.getElementById('scenario').value;  // Ensure scenario ID is included
        const csrfToken = getCookie('csrftoken');

        fetch('/api/stock/sell/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({ stock_id: stockId, amount: amount, price: price, scenario_id: scenarioId }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Stock sold successfully');
                location.reload(); // Reload the page to update the portfolio and transactions
            } else {
                alert(data.message);
            }
        })
        .catch(error => console.error('Error:', error));
    }
</script>
{% endblock %}
